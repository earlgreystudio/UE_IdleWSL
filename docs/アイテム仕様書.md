# アイテムシステム仕様書

## ⚠️ 重要な変更（2024年6月24日）

**古いItemManagerシステムは削除されました。以下の新しいシステムをご使用ください：**
- ❌ 削除: `UItemManager`, `FItemData`, `FWeaponData`, `FArmorData`, `FConsumableData` 
- ✅ 使用: `UItemDataTableManager`, `FItemDataRow`

## ブループリントでできること（主要機能）

### グローバル倉庫管理（GlobalInventoryComponent）
**アクセス方法**: `PlayerControllerから Get Component (Global Inventory Component)`
**クラス**: アクターコンポーネント（UActorComponent）

- **AddItemToStorage** - 倉庫にアイテム追加
- **RemoveItemFromStorage** - 倉庫からアイテム削除
- **TransferToCharacter** - 倉庫→キャラクター転送
- **TransferFromCharacter** - キャラクター→倉庫転送
- **GetAllStorageSlots** - 倉庫の全スロット取得（InventorySlot配列、耐久度別）
- **BuyItem** - アイテム購入
- **SellItem** - アイテム売却（数量指定）
- **SellItemInstance** - 個別アイテム売却（耐久度考慮価格）
- **AddMoney** - 通貨追加
- **SpendMoney** - 通貨消費
- **GetMoney** - 現在通貨取得
- **GetItemInstanceSellPrice** - 個別アイテム売値取得（耐久度考慮）

### キャラクター個人管理（CharacterInventoryComponent）
**アクセス方法**: `キャラクターから直接取得 → Get Component (Character Inventory Component)`
**クラス**: アクターコンポーネント（UActorComponent）

- **AddItem** - キャラクターにアイテム追加  
- **RemoveItem** - アイテム削除
- **GetAllInventorySlots** - キャラクターの全スロット取得（InventorySlot配列、耐久度別）
- **EquipItem** - 統一装備（自動判定・競合解決）
- **EquipItemInstance** - 個別アイテム装備（InstanceId指定）
- **EquipWeapon** - 武器装備（個別指定）
- **EquipArmor** - 防具装備（個別指定）
- **UnequipWeapon** - 武器を外す
- **UnequipArmor** - 防具を外す
- **CanEquipItem** - 装備品かどうか判定（武器・防具ならtrue、それ以外はfalse）
- **UseConsumable** - 消耗品使用
- **GetTotalWeight** - 総重量計算
- **SellItemInstance** - 個別アイテム売却（耐久度考慮価格）
- **GetItemInstanceSellPrice** - 個別アイテム売値取得（耐久度考慮）
- **HasItem** - アイテム所持判定
- **GetItemQuantity** - アイテム数量取得
- **TransferToCharacter** - 他キャラクターにアイテム転送（数量指定）
- **TransferItemInstanceToCharacter** - 他キャラクターに個別アイテム転送（InstanceId指定）

### アイテムデータ管理（ItemDataTableManager）
**アクセス方法**: `Get Game Instance → Get Subsystem (Item Data Table Manager)`
**クラス**: サブシステム（UGameInstanceSubsystem）

- **GetItemData** - アイテム詳細取得（FItemDataRow構造体）
- **GetAllItems** - 全アイテム取得（FItemDataRow配列）
- **GetItemsByType** - タイプ別アイテム取得（アイテムタイプ情報）
- **IsValidItem** - アイテムID有効性チェック
- **GetItemValue** - アイテム基準価格取得

### イベント・通知
- **OnStorageChanged** - 倉庫アイテム変更時に発火（GlobalInventoryComponent）
- **OnMoneyChanged** - 通貨変更時に発火（GlobalInventoryComponent）
- **OnInventoryChanged** - キャラクターインベントリ変更時に発火（CharacterInventoryComponent）

---

## 概要

統一されたアイテムシステムにより、武器・防具・消耗品をUnreal EngineのDataTableで管理。
装備スロットの一致により装備可能性を判定し、直感的なステータス効果システムを採用。


---

## アイテムタイプ

### EItemTypeTable（基本分類）

| タイプ | 説明 | 装備可能 |
|--------|------|----------|
| Weapon | 武器 | ✅ |
| Armor | 防具・アクセサリ | ✅ |
| Consumable | 消耗品 | ❌ |
| Material | 素材 | ❌ |
| Quest | クエストアイテム | ❌ |
| Misc | その他 | ❌ |

### EEquipmentSlotTable（装備スロット）

| スロット | 説明 | 個数 |
|----------|------|------|
| None | 装備不可 | - |
| Weapon | 武器 | 1 |
| Shield | 盾 | 1 |
| Head | 頭防具 | 1 |
| Body | 胴防具 | 1 |
| Legs | 脚防具 | 1 |
| Hands | 手防具 | 1 |
| Feet | 足防具 | 1 |
| Accessory | アクセサリ | 2 |

### EItemQualityTable（アイテム品質）

| 品質 | 説明 | 補正倍率 |
|------|------|----------|
| Poor | 粗悪 | 0.7倍 (-30%) |
| Common | 普通 | 1.0倍 (基準) |
| Good | できの良い | 1.3倍 (+30%) |
| Masterwork | 名匠 | 1.6倍 (+60%) |
| Legendary | マスターワーク | 2.0倍 (+100%) |

**品質による補正対象:**
- 攻撃力 (`GetModifiedAttackPower()`)
- 防御力 (`GetModifiedDefense()`)
- 耐久度 (`GetModifiedDurability()`)
- 価値 (`GetModifiedValue()`)

---

## 基本プロパティ

### 全アイテム共通（FItemDataRow）

```cpp
FString ItemId;                   // 一意ID
FText Name;                       // 表示名
FText Description;                // 説明文
EItemTypeTable ItemType;          // アイテムタイプ
EEquipmentSlotTable EquipmentSlot; // 装備スロット
int32 StackSize;                  // スタック可能数（1=個別管理）
float Weight;                     // 重量（kg）
int32 BaseValue;                  // 基準価値（ゴールド）
ETradeCategoryTable TradeCategory; // 取引カテゴリ
int32 MaxDurability;              // 最大耐久度
EItemQualityTable Quality;        // アイテム品質
```

### 武器専用プロパティ

```cpp
int32 AttackPower;        // 攻撃力（1-15）
ESkillType RequiredSkill; // 必要スキル
float CriticalBonus;      // クリティカル率ボーナス
float AttackRange;        // 射程距離（遠距離武器のみ）
int32 RequiredStrength;   // 必要筋力
int32 RequiredDexterity;  // 必要器用
```

### 防具専用プロパティ

```cpp
int32 Defense;            // 防御力（1-5）
TMap<FString, int32> StatBonuses; // 能力値ボーナス
int32 RequiredStrength;   // 必要筋力
```

### 消耗品プロパティ（直接効果）

```cpp
int32 Health;             // HP回復/変更
int32 Stamina;            // スタミナ回復/変更
int32 Strength;           // 力変更
int32 Agility;            // 敏捷変更
int32 Intelligence;       // 知力変更
int32 Dexterity;          // 器用変更
float Duration;           // 持続時間（0=即座）
bool CurePoison;          // 毒治療
bool CureBleeding;        // 出血治療
```

---

## アイテム管理システム

### インスタンス管理

- **スタック可能アイテム**（StackSize > 1）
  - 消耗品、素材など
  - 数量のみ管理、個別の耐久度なし

- **個別管理アイテム**（StackSize = 1）
  - 武器、防具
  - 各インスタンスが固有のGUIDと耐久度を持つ

### データ構造

```cpp
struct FItemInstance
{
    FGuid InstanceId;         // 固有ID
    FString ItemId;           // アイテムタイプ
    int32 CurrentDurability;  // 現在耐久度
    TMap<FString, float> CustomData; // カスタムデータ
};

struct FInventorySlot
{
    FString ItemId;           // アイテムID
    int32 Quantity;           // 総数量
    TArray<FItemInstance> ItemInstances; // 個別インスタンス
};
```

---

## 装備システム

### 装備判定

```cpp
bool CanEquipToSlot(const FString& ItemId, EEquipmentSlot Slot)
{
    const FItemData* Item = GetItemData(ItemId);
    return Item && Item->EquipmentSlot == Slot;
}
```

### 武器装備制限

**両手武器・長柄武器・射程武器は盾と同時装備不可**

```cpp
bool BlocksShield() const 
{
    return IsWeapon() && (
        RequiredSkill == ESkillType::TwoHandedWeapons ||
        RequiredSkill == ESkillType::PolearmWeapons ||
        RequiredSkill == ESkillType::Archery ||
        RequiredSkill == ESkillType::Firearms
    );
}
```

| 武器種類 | 盾装備 | 理由 |
|----------|--------|------|
| 片手武器 | ✅ | 片手が空いている |
| 格闘武器 | ✅ | 腕に装着可能 |
| 両手武器 | ❌ | 両手で持つ必要 |
| 長柄武器 | ❌ | 両手で操作 |
| 弓・銃 | ❌ | 両手で構える |
| 投擲武器 | ❌ | 投げる際に盾が邪魔 |

### 装備スロット構造

```cpp
struct FEquipmentSlots
{
    FItemInstance Weapon;     // 武器
    FItemInstance Shield;     // 盾
    FItemInstance Head;       // 頭
    FItemInstance Body;       // 胴
    FItemInstance Legs;       // 脚
    FItemInstance Hands;      // 手
    FItemInstance Feet;       // 足
    FItemInstance Accessory1; // アクセサリ1
    FItemInstance Accessory2; // アクセサリ2
};
```

---

## DataTableシステム

### CSVデータ形式（ItemData.csv）

DataTableはCSVファイルからインポートして使用します。

**ヘッダー行:**
```csv
Name,ItemId,Description,ItemType,StackSize,Weight,BaseValue,TradeCategory,MaxDurability,EquipmentSlot,AttackPower,RequiredSkill,CriticalBonus,AttackRange,RequiredStrength,RequiredDexterity,Defense,Quality,Health,Stamina,Strength,Agility,Intelligence,Dexterity,Duration,CurePoison,CureBleeding
```

### 武器例（CSV行）

```csv
"鉄の剣","iron_sword","頑丈な鉄製の剣","Weapon",1,1.5,200,"MeleeWeapons",120,"Weapon",10,"OneHandedWeapons",0.03,0,12,8,0,"Common",0,0,0,0,0,0,0.0,false,false
```

### 高品質武器例（CSV行）

```csv
"マスターワークの鉄剣","iron_sword_legendary","伝説級の職人が生涯をかけて鍛えた最高傑作","Weapon",1,1.5,200,"MeleeWeapons",120,"Weapon",10,"OneHandedWeapons",0.03,0,12,8,0,"Legendary",0,0,0,0,0,0,0.0,false,false
```

### 防具例（CSV行）

```csv
"鉄兜","iron_helmet","重厚な鉄製の兜","Armor",1,2.0,120,"MeleeWeapons",120,"Head",0,"OneHandedWeapons",0.0,0,0,0,3,"Common",0,0,0,0,0,0,0.0,false,false
```

### 消耗品例（CSV行）

```csv
"万能エリクサー","super_elixir","全てを回復し強化する","Consumable",5,0.5,2000,"Medicine",0,"None",0,"OneHandedWeapons",0.0,0,0,0,0,"Legendary",100,100,3,3,3,3,600.0,true,true
```

---

## 重量システム

### 装備重量率計算

```
装備重量率 = 装備総重量 ÷ 積載量
```

### ペナルティ段階

| 装備重量率 | 状況 | ペナルティ |
|-----------|------|-----------|
| 70%以上 | ほぼ動けない | 90% |
| 50-70% | 重装備 | 60-90% |
| 20-50% | 中装備 | 20-60% |
| 10-20% | 軽装備 | 5-20% |
| 10%未満 | ほぼ影響なし | 0-5% |

---

## 耐久度システム

### 耐久度管理

- **武器・防具**: 使用により耐久度減少
- **消耗品**: 耐久度なし（使用で消失）
- **修理**: ItemManagerで修理コスト計算

### 耐久度による影響

- **武器**: 耐久度低下で攻撃力減少
- **防具**: 耐久度低下で防御力減少
- **破損**: 耐久度0で装備不可

---

## 効果システム

### 消耗品効果の原則

**「値が存在する = 効果がある」**

- `health: 30` → HP+30
- `strength: 5` → 力+5
- `duration: 300` → 5分間持続
- `curePoison: true` → 毒治療

### 複合効果

単一アイテムで複数効果を同時発動可能：

```json
{
  "health": 15,        // HP+15
  "stamina": 10,       // スタミナ+10  
  "strength": 5,       // 力+5（一時的）
  "duration": 300,     // 5分間持続
  "curePoison": true   // 毒も治療
}
```

---

## ファイル構成

### データファイル

- `Content/Data/ItemData.csv` - DataTable用CSVファイル

### クラス構成

- `UItemDataTableManager` - DataTableベースのアイテム管理
- `FItemDataRow` - DataTable行構造（FTableRowBase継承）
- `UCharacterInventoryComponent` - キャラクターのインベントリ管理
- `FItemInstance` - アイテムインスタンス
- `FInventorySlot` - インベントリスロット
- `FEquipmentSlots` - 装備スロット構造

---

## 使用例・設定方法

### DataTable設定

1. **Unreal Editorでの設定**
   - `ItemData.csv`をインポート
   - Row Structure: `Item Data Row`を選択
   - DataTableアセットとして保存（例: `DT_ItemData`）

2. **ItemDataTableManagerの設定**
   - GameInstanceからSubsystemを取得
   - `ItemDataTable`プロパティにDataTableアセットを設定

### ブループリント使用例

1. **アイテム購入から装備まで**
   ```
   PlayerController → Get Component (Global Inventory Component) 
   → Buy Item (iron_sword, 1) 
   → Transfer To Character (キャラクターのCharacterInventoryComponent, iron_sword, 1)
   → [キャラクター] → Get Component (Character Inventory Component) → Equip Weapon (iron_sword)
   ```

2. **倉庫の耐久度別リスト表示**
   ```
   PlayerController → Get Component (Global Inventory Component) 
   → Get All Storage Slots → For Each Loop
   → [各スロットで] Item Id, Quantity, Item Instances (個別耐久度)を表示
   ```

3. **個別アイテム売却（耐久度考慮）**
   ```
   [リストから選択したアイテム] → Instance Id を取得
   → PlayerController → Get Component (Global Inventory Component) 
   → Get Item Instance Sell Price (Instance Id) で売値確認
   → Sell Item Instance (Instance Id) で売却実行
   ```

4. **全武器リスト取得**
   ```
   Get Game Instance → Get Subsystem (Item Data Table Manager) 
   → Get Items by Type (Weapon)
   ```

5. **アイテムデータ詳細取得**
   ```
   Get Game Instance → Get Subsystem (Item Data Table Manager)
   → Get Item Data (ItemId) → FItemDataRow構造体で全データ取得
   ```

6. **キャラクター間アイテム転送**
   ```
   [渡す側キャラクター] → Get Component (Character Inventory Component)
   → Transfer To Character (受け取り側のCharacterInventoryComponent, ItemId, Quantity)
   ```

7. **キャラクター間個別アイテム転送（耐久度保持）**
   ```
   [渡す側キャラクター] → Get Component (Character Inventory Component)
   → Transfer Item Instance To Character (受け取り側のCharacterInventoryComponent, InstanceId)
   ```

8. **統一装備システム（自動判定・競合解決）**
   ```
   [キャラクター] → Get Component (Character Inventory Component)
   → Equip Item (ItemId)
   
   # または個別アイテム指定
   → Equip Item Instance (InstanceId)
   ```

9. **イベント監視（UI更新）**
   ```
   [BeginPlay時]
   PlayerController → Get Component (Global Inventory Component)
   → Bind Event to OnStorageChanged → カスタムイベント「UpdateStorageUI」
   ```

---

## 更新履歴

- **2024年6月24日**: DataTableシステムに移行
- JSONファイル削除、CSVベースのDataTable採用
- UItemDataTableManager実装
- ブループリント関数をDataTable対応に更新
- コンパイル・リンクエラー問題を根本解決
- **2024年6月24日**: クオリティシステム追加
- アイテム品質（5段階）実装
- 品質による補正値システム追加
- ブループリント関数リファレンス追加
- **2024年6月23日**: 初版作成
- 統一アイテムシステム設計完了  
- シンプルな効果システム実装
- インスタンス管理システム追加