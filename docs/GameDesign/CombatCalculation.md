# 戦闘システム計算式

## 概要

キャラクターの戦闘における命中・回避・ダメージ計算の仕様書。
装備重量による行動制限も含む。

## 装備重量ペナルティ

### 装備重量率の計算
```
装備重量率 = 装備総重量 ÷ 積載量
```

### ペナルティ段階

| 装備重量率 | 状況 | ペナルティ |
|-----------|------|-----------|
| 70%以上 | ほぼ動けない | 90% |
| 50-70% | 重装備 | 60-90% |
| 20-50% | 中装備 | 20-60% |
| 10-20% | 軽装備 | 5-20% |
| 10%未満 | ほぼ影響なし | 0-5% |

### 詳細計算式
```
if (装備重量率 >= 0.7f)
    ペナルティ = 90%
else if (装備重量率 >= 0.5f)
    ペナルティ = 60 + (装備重量率 - 0.5) × 150
else if (装備重量率 >= 0.2f)
    ペナルティ = 20 + (装備重量率 - 0.2) × 133
else if (装備重量率 >= 0.1f)
    ペナルティ = 5 + (装備重量率 - 0.1) × 150
else
    ペナルティ = 装備重量率 × 50
```

## 命中・回避判定

### 回避率
```
基本回避率 = 10 + (敏捷 × 2) + (回避スキル × 3)
最終回避率 = 基本回避率 - 装備ペナルティ
```

**説明**:
- 主要因子: 敏捷（身のこなし）・回避スキル
- 装備が重いほど回避困難

### 受け流し率
```
基本受け流し率 = 5 + (器用 × 1.5) + (受け流しスキル × 3)
最終受け流し率 = 基本受け流し率 - 装備ペナルティ
```

**説明**:
- 主要因子: 器用（武器操作）・受け流しスキル
- 武器や盾で攻撃を逸らす技術

### 命中率
```
基本命中率 = 50 + (スキルレベル × 2) + (器用 × 1.5) - (武器重量 ÷ (力 × 0.5))
```

**説明**:
- 主要因子: スキルレベル・器用
- 武器が重すぎると命中率低下
- 力があれば重い武器でも扱える

### 判定順序
1. **回避判定** → 成功ならダメージ0で終了
2. **受け流し判定** → 成功ならダメージ80%カット
3. **通常の防御計算** → 最終ダメージ決定

## ダメージ計算

### 基本ダメージ
```
武器ダメージ = 武器攻撃力 × (1 + (スキルレベル ÷ 20))
能力補正 = 力 × 0.5 (近接武器) または 器用 × 0.5 (遠距離武器)
基本ダメージ = 武器ダメージ + 能力補正
```

**説明**:
- スキルレベルが高いほど武器の威力を引き出せる
- 近接武器は力、遠距離武器は器用で威力向上

### 防御計算
```
防御値 = 防具防御力 + (頑丈 × 0.3)
最終ダメージ = 基本ダメージ × (100 ÷ (100 + 防御値))
```

**説明**:
- 防具と体の頑丈さで軽減
- 防御値が高いほど軽減率向上

### クリティカルヒット
```
クリティカル率 = 5 + (器用 × 0.5) + (スキルレベル × 0.3)
クリティカルダメージ = 基本ダメージ × 2
```

**説明**:
- 器用とスキルで急所を狙う確率向上
- クリティカル時は2倍ダメージ

## 戦闘例

### 軽装剣士 vs 重装戦士

**軽装剣士（積載量50kg、装備8kg）**
- 装備重量率: 16% → ペナルティ9%
- 回避率: 高い（軽装）
- ダメージ: 中程度

**重装戦士（積載量40kg、装備25kg）**
- 装備重量率: 62.5% → ペナルティ67.5%
- 回避率: 非常に低い
- ダメージ: 高い（防御無視時）

## 実装関数

```cpp
// C++実装予定
UCombatCalculator::CalculateHitChance(Attacker, Target)
UCombatCalculator::CalculateDamage(Attacker, Target, Weapon)
UCombatCalculator::CheckEvasion(Character, EquipmentPenalty)
```

## 攻撃速度計算

### 近接武器の攻撃速度
```
基本攻撃速度 = 2.0 + (敏捷 × 0.02) + (スキルレベル × 0.01)
武器重量ペナルティ = 武器重量 ÷ (力 × 0.3)
最終攻撃速度 = 基本攻撃速度 - 武器重量ペナルティ
```

**計算例**:

| キャラクター | 力 | 敏捷 | スキル | 武器 | 重量 | 基本速度 | ペナルティ | 最終速度 |
|------------|---|-----|-------|-----|------|---------|-----------|----------|
| 力自慢剣士 | 30 | 15 | 10 | 片手剣 | 2kg | 2.40 | 0.22 | **2.18回/秒** |
| 力自慢剣士 | 30 | 15 | 10 | 両手剣 | 5kg | 2.40 | 0.56 | **1.84回/秒** |
| 軽装剣士 | 15 | 25 | 15 | 片手剣 | 2kg | 2.65 | 0.44 | **2.21回/秒** |
| 軽装剣士 | 15 | 25 | 15 | 両手剣 | 5kg | 2.65 | 1.11 | **1.54回/秒** |
| 熟練戦士 | 25 | 20 | 20 | 片手剣 | 2kg | 2.60 | 0.27 | **2.33回/秒** |
| 熟練戦士 | 25 | 20 | 20 | 両手剣 | 5kg | 2.60 | 0.67 | **1.93回/秒** |
| 初心者 | 10 | 10 | 5 | 片手剣 | 2kg | 2.25 | 0.67 | **1.58回/秒** |
| 初心者 | 10 | 10 | 5 | 両手剣 | 5kg | 2.25 | 1.67 | **0.58回/秒** |
| 重武器使い | 40 | 10 | 15 | 大剣 | 8kg | 2.25 | 0.67 | **1.58回/秒** |
| 軽戦士 | 20 | 30 | 12 | 短剣 | 1kg | 2.72 | 0.17 | **2.55回/秒** |

### 遠距離武器の攻撃速度
```
基本攻撃速度 = 1.0 + (器用 × 0.01) + (スキルレベル × 0.03)
最終攻撃速度 = 基本攻撃速度
```

**計算例**:

| キャラクター | 器用 | スキル | 武器 | 基本速度 | 最終速度 |
|------------|-----|-------|-----|---------|----------|
| 弓術初心者 | 15 | 5 | 弓 | 1.30 | **1.30回/秒** |
| 熟練弓兵 | 25 | 15 | 弓 | 1.70 | **1.70回/秒** |
| 達人弓兵 | 30 | 25 | 弓 | 2.05 | **2.05回/秒** |
| 投擲専門 | 20 | 18 | 投擲 | 1.74 | **1.74回/秒** |
| 射撃兵 | 28 | 20 | 銃 | 1.88 | **1.88回/秒** |

**説明**:
- 近接武器: 力不足だと重い武器は扱えない
- 遠距離武器: スキルレベルの影響が大きい（狙いの精度・連射技術）
- 器用さは補助的な役割（武器の扱いやすさ）

## 更新履歴

- **2024年6月23日**: 初版作成
- 装備重量ペナルティシステム設計完了
- 攻撃速度計算システム追加